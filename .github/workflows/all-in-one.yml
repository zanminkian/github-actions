name: CI

on:
  workflow_call:
    inputs:
      assets:
        description: A directory path to release assets
        type: string
        required: false
    outputs:
      published:
        description: A boolean value to indicate whether a publishing is happened or not
        value: ${{ jobs.release.outputs.published }}
      publishedPackages:
        description: >
          A JSON array to present the published packages. The format is `[{"name": "@xx/xx", "version": "1.2.0"}, {"name": "@xx/xy", "version": "0.8.9"}]`
        value: ${{ jobs.release.outputs.publishedPackages }}
    secrets:
      TOKENS:
        description: JSON string of tokens. Each key-value pair will become an environment variable
        required: false

jobs:
  prepare-test-matrix:
    name: Prepare Test Matrix
    runs-on: ubuntu-latest
    outputs:
      test-matrix: ${{ steps.resolve-versions.outputs.test-matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v2
        with:
          deno-version: lts
      - name: Resolve Node.js versions
        id: resolve-versions
        run: |
          # Create version resolver script
          cat > /tmp/version-resolver.js << 'EOF'
          import { compare, parse, parseRange, satisfies } from "jsr:@std/semver";

          async function resolveVersions() {
            // 1. Get the version range
            const packageJson = JSON.parse(await Deno.readTextFile("package.json"));
            // Handle both single runtime object and array of runtime objects
            const runtimes = Array.isArray(packageJson?.devEngines?.runtime)
              ? packageJson.devEngines.runtime
              : packageJson?.devEngines?.runtime
                ? [packageJson.devEngines.runtime]
                : [];
            const nodeRuntime = runtimes.find((runtime) => runtime?.name === "node");
            if (!nodeRuntime) {
              throw new Error("Not a Node.js project");
            }
            const versionRange = nodeRuntime.version;
            if (!versionRange) {
              throw new Error(
                "No Node.js version specified in devEngines.runtime.version",
              );
            }
            console.log(`Resolving versions for range: ${versionRange}`);

            // 2. Find the min and max versions
            const response = await fetch("https://nodejs.org/dist/index.json");
            if (!response.ok) {
              throw new Error(
                `Failed to fetch Node.js versions: ${response.status} ${response.statusText}`,
              );
            }
            const json = await response.json();
            const satisfyingVersions = json
              .map((item) => item.version.substring(1)) // Remove 'v' prefix
              .filter((version) => parse(version).prerelease.length === 0)
              .filter((version) => satisfies(parse(version), parseRange(versionRange)))
              .sort((x, y) => compare(parse(x), parse(y)));
            if (satisfyingVersions.length === 0) {
              throw new Error(
                `No Node.js versions found that satisfy the range: ${versionRange}`,
              );
            }
            const minVersion = satisfyingVersions[0];
            const maxVersion = satisfyingVersions[satisfyingVersions.length - 1];
            const versionsSame = minVersion === maxVersion;
            console.log(
              `Min version: ${minVersion}, Max version: ${maxVersion}, Same: ${versionsSame}`,
            );

            // 3. Generate test matrix
            const include = versionsSame
              ? [
                  {
                    "node-version": minVersion,
                    "version-label": minVersion,
                  },
                ]
              : [
                  {
                    "node-version": minVersion,
                    "version-label": `${minVersion} (min)`,
                  },
                  {
                    "node-version": maxVersion,
                    "version-label": `${maxVersion} (max)`,
                  },
                ];

            // 4. Write to GITHUB_OUTPUT
            const githubOutput = Deno.env.get("GITHUB_OUTPUT");
            if (githubOutput) {
              await Deno.writeTextFile(
                githubOutput,
                `test-matrix=${JSON.stringify({ matrix: { include } })}\n`,
                { append: true },
              );
            }
          }

          await resolveVersions();
          EOF

          # Execute the script
          deno run --allow-net --allow-read --allow-write --allow-env /tmp/version-resolver.js

  test:
    name: Test (Node.js ${{ matrix.version-label }})
    needs: prepare-test-matrix
    runs-on: ubuntu-latest
    strategy: ${{ fromJSON(needs.prepare-test-matrix.outputs.test-matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Check .changeset/config.json
        run: |
          if [ "$(jq -e '.baseBranch' .changeset/config.json)" != "\"main\"" ]; then
            echo "Error: .changeset/config.json baseBranch should be \"main\""
            exit 1
          fi
          if [ "$(jq -e '.privatePackages.version' .changeset/config.json)" != true ]; then
            echo "Error: .changeset/config.json privatePackages.version should be true"
            exit 1
          fi
          if [ "$(jq -e '.privatePackages.tag' .changeset/config.json)" != true ]; then
            echo "Error: .changeset/config.json privatePackages.tag should be true"
            exit 1
          fi
      - name: Install and test
        run: |
          npm i @rnm/pm -g
          pm-util enable-shim
          pm install
          pm run test
      - name: Check git status
        run: |
          if [ "$(git status --porcelain | wc -l)" -ne 0 ]; then echo "Error: Git status is not clean"; git status; exit 1; fi
  release:
    name: Release
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/prerelease') }}
    needs: test
    runs-on: ubuntu-latest
    concurrency:
      group: changesets-release # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/control-the-concurrency-of-workflows-and-jobs
    permissions:
      contents: write # to create release (changesets/action)
      id-token: write # OpenID Connect token needed for provenance
      pull-requests: write # to create pull request (changesets/action)
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      publishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
    steps:
      - uses: actions/checkout@v4
      # TODO: Remove this step when https://github.com/actions/setup-node/pull/1283 is merged
      - name: Get Node.js version
        id: get-node-version
        run: |
          # Handle both single runtime object and array of runtime objects
          node_version=$(jq -r '
            if (.devEngines.runtime | type) == "array" then
              (.devEngines.runtime[] | select(.name == "node") | .version) // empty
            else
              (if .devEngines.runtime.name == "node" then .devEngines.runtime.version else empty end)
            end
          ' package.json)
          if [ -z "$node_version" ]; then
            echo "Error: No Node.js version specified in devEngines.runtime.version"
            exit 1
          fi
          echo "node-version=$node_version" >> $GITHUB_OUTPUT
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.get-node-version.outputs.node-version }}
      - run: |
          npm i @rnm/pm -g
          pm-util enable-shim
          pm install

      - name: Secrets to Envs
        run: |
          if [ "${{ secrets.TOKENS }}" != "" ]; then
            echo ${{ toJSON(secrets.TOKENS) }} | jq -r 'to_entries[] | "\(.value)"' | while read value; do echo "::add-mask::$value"; done
            echo ${{ toJSON(secrets.TOKENS) }} | jq -r 'to_entries[] | "\(.key)=\(.value)"' >> $GITHUB_ENV
          else
            echo "No TOKENS provided, skipping token setup"
          fi
          echo 'GITHUB_TOKEN=${{ secrets.github_token }}' >> $GITHUB_ENV

      - name: Create Publish Script
        run: |
          echo '#!/usr/bin/env bash' > /tmp/zanminkian_publish.sh
          echo 'set -ex' >> /tmp/zanminkian_publish.sh
          echo 'export NPM_CONFIG_GIT_CHECKS=false' >> /tmp/zanminkian_publish.sh
          echo 'export NPM_CONFIG_PROVENANCE=true' >> /tmp/zanminkian_publish.sh
          echo 'export NPM_CONFIG_TAG=$(test -f ".changeset/pre.json" && jq -r ".tag" .changeset/pre.json || echo "latest")' >> /tmp/zanminkian_publish.sh
          echo 'pm run release' >> /tmp/zanminkian_publish.sh
          echo './node_modules/.bin/changeset tag' >> /tmp/zanminkian_publish.sh

      - name: Create Release Pull Request or Publish
        id: changesets
        # https://github.com/changesets/action
        uses: changesets/action@v1
        with:
          publish: "sh /tmp/zanminkian_publish.sh"
          commit: "chore: release"
          title: "chore: release"

      - name: Upload Release Assets
        if: ${{ (inputs.assets != '') && (steps.changesets.outputs.published == 'true') }}
        run: |
          version=$(echo '${{ steps.changesets.outputs.publishedPackages }}' | jq -r '.[0].version')
          echo "published version is $version"
          release_id=$(
            curl -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.github_token }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/v$version" | jq -r ".id"
          )
          echo "release id is $release_id"
          if [ -z "$release_id" ] || [ "$release_id" = "null" ]; then
            echo "Error: Failed to get release ID. Release may not exist for version $version"
            exit 1
          fi

          for file in $(ls ${{ inputs.assets }}); do
            echo "${{ inputs.assets }}/$file"
            curl -L \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.github_token }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/octet-stream" \
              "https://uploads.github.com/repos/${{ github.repository }}/releases/$release_id/assets?name=$file" \
              -T "${{ inputs.assets }}/$file" >/dev/null 2>&1
          done
